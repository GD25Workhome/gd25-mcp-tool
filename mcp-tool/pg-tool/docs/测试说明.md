# PostgreSQL MCP 服务器测试说明

本文档说明如何在 Cursor 中测试 PostgreSQL MCP 服务器的各项功能。

## 前置条件

1. ✅ 已完成服务器配置（参考 [使用说明.md](./使用说明.md)）
2. ✅ Cursor 已重启并加载 MCP 配置
3. ✅ PostgreSQL 数据库已启动并可连接
4. ✅ 数据库中已有测试数据（至少有一个表）

## 验证服务器连接

### 1. 检查 MCP 服务器状态

在 Cursor 中，你可以通过以下方式验证服务器是否正常运行：

**提示词：**
```
检查一下 PostgreSQL MCP 服务器是否已连接
```

**预期结果：**
- Cursor 应该能够识别到 `postgres-mcp-server`
- 如果连接成功，Cursor 会显示可用的工具和资源

### 2. 查看可用功能

**提示词：**
```
列出 PostgreSQL MCP 服务器提供的所有工具和资源
```

**预期结果：**
- 应该能看到 `query` 工具
- 应该能看到表结构资源（`table://*` 和各个表）

## 测试工具（Tools）

### 测试 1：基本 SELECT 查询

**提示词：**
```
查询数据库中的所有表
```

或者更具体：
```
使用 query 工具执行 SQL：SELECT table_schema, table_name FROM information_schema.tables WHERE table_schema NOT IN ('information_schema', 'pg_catalog') AND table_type = 'BASE TABLE' LIMIT 10
```

**预期结果：**
- 返回数据库中的表列表
- 结果格式为 JSON，包含 `columns`、`rows` 和 `row_count`

### 测试 2：查询特定表的数据

**提示词：**
```
查询 users 表的前 10 条记录
```

或者：
```
帮我查询一下 users 表的数据，只返回前 5 条
```

**预期结果：**
- 返回指定表的数据
- 结果包含所有列和对应的值

### 测试 3：带条件的查询

**提示词：**
```
查询 users 表中 id 大于 100 的记录
```

或者：
```
查找 users 表中 status 为 'active' 的用户，只返回前 20 条
```

**预期结果：**
- 返回符合条件的数据
- 结果格式正确

### 测试 4：聚合查询

**提示词：**
```
统计 users 表中的总记录数
```

或者：
```
查询每个 status 的用户数量
```

**预期结果：**
- 返回聚合查询结果
- 结果格式正确

### 测试 5：写操作测试（如果启用）

如果设置了 `DANGEROUSLY_ALLOW_WRITE_OPS=true`：

**提示词：**
```
插入一条测试数据到 users 表
```

**预期结果（如果启用写操作）：**
- 成功执行 INSERT 操作
- 返回受影响的行数

**预期结果（如果未启用写操作）：**
- 返回错误：写操作被禁用

## 测试资源（Resources）

### 测试 1：列出所有表

**提示词：**
```
查看数据库中有哪些表
```

或者：
```
读取 table://* 资源，显示所有表
```

**预期结果：**
- 返回所有表的列表
- 包含 `schema_name` 和 `table_name`

### 测试 2：查看表结构

**提示词：**
```
查看 users 表的结构
```

或者：
```
读取 table://public/users 资源，显示表结构信息
```

**预期结果：**
- 返回表的完整结构信息
- 包含：
  - 表名和模式名
  - 所有列的详细信息（列名、数据类型、是否可空、默认值）
  - 主键信息

### 测试 3：查看多个表的结构

**提示词：**
```
查看 users 和 orders 两个表的结构
```

**预期结果：**
- 分别返回两个表的结构信息

## 测试提示（Prompts）

### 测试 1：使用查询示例提示

**提示词：**
```
使用 query-example 提示，查询 users 表的前 10 条记录
```

**预期结果：**
- Cursor 使用预定义的查询模板
- 生成并执行相应的 SQL 查询

### 测试 2：使用表结构查询提示

**提示词：**
```
使用 schema-query 提示，查看 users 表的结构
```

**预期结果：**
- Cursor 使用预定义的表结构查询模板
- 返回表结构信息

### 测试 3：使用连接查询提示

**提示词：**
```
使用 join-query 提示，查询 users 和 orders 表的连接数据
```

**预期结果：**
- Cursor 使用预定义的连接查询模板
- 生成并执行 JOIN 查询

## 综合测试场景

### 场景 1：探索数据库结构

**提示词序列：**

1. **第一步：**
```
列出数据库中的所有表
```

2. **第二步：**
```
查看 users 表的结构
```

3. **第三步：**
```
查询 users 表的前 5 条数据，看看数据格式
```

**预期流程：**
- 先获取表列表
- 然后查看表结构了解字段
- 最后查看实际数据

### 场景 2：数据分析查询

**提示词：**
```
帮我分析一下 users 表：
1. 总共有多少条记录
2. 按 status 分组统计数量
3. 显示最近创建的 10 个用户
```

**预期结果：**
- 执行多个查询
- 返回分析结果

### 场景 3：复杂查询

**提示词：**
```
查询 users 表和 orders 表，找出每个用户的订单总数和总金额，按订单总数降序排列，只显示前 10 个
```

**预期结果：**
- 执行 JOIN 查询
- 返回聚合结果
- 正确排序和限制

## 测试日志功能

### 查看日志输出

服务器日志会输出到 stderr。你可以在终端中查看日志：

```bash
# 如果直接在终端运行服务器
python server.py

# 日志会显示：
# - 数据库连接状态
# - 查询执行情况
# - 错误信息（如果有）
```

### 测试不同日志级别

在 Cursor 配置中设置 `LOG_LEVEL` 环境变量：

```json
{
  "mcpServers": {
    "postgres": {
      "command": "/opt/homebrew/Caskroom/miniconda/base/envs/py311_gb25MCP_01/bin/python",
      "args": [
        "/path/to/server.py"
      ],
      "env": {
        "DATABASE_URL": "postgresql://...",
        "LOG_LEVEL": "DEBUG"
      }
    }
  }
}
```

**日志级别选项：**
- `DEBUG`: 最详细的日志（包括所有调试信息）
- `INFO`: 一般信息（默认）
- `WARNING`: 警告信息
- `ERROR`: 错误信息
- `CRITICAL`: 严重错误

## 测试缓存功能

### 测试查询缓存

1. **第一次查询：**
```
查询 users 表的前 10 条记录
```

2. **立即再次查询相同内容：**
```
查询 users 表的前 10 条记录
```

**预期结果：**
- 第一次查询会执行数据库查询
- 第二次查询会使用缓存（如果启用）
- 日志中会显示 "使用缓存结果"

### 测试缓存失效

1. **查询数据：**
```
查询 users 表的前 10 条记录
```

2. **等待缓存过期（默认 300 秒）或执行写操作**

3. **再次查询：**
```
查询 users 表的前 10 条记录
```

**预期结果：**
- 缓存过期后，会重新执行数据库查询

## 错误处理测试

### 测试 1：无效 SQL

**提示词：**
```
执行这个 SQL：SELECT * FROM nonexistent_table
```

**预期结果：**
- 返回清晰的错误信息
- 说明表不存在

### 测试 2：语法错误

**提示词：**
```
执行这个 SQL：SELCT * FROM users
```

**预期结果：**
- 返回 SQL 语法错误信息

### 测试 3：权限错误

**提示词（如果未启用写操作）：**
```
执行这个 SQL：INSERT INTO users (name) VALUES ('test')
```

**预期结果：**
- 返回错误：写操作被禁用
- 提示如何启用写操作

### 测试 4：表不存在

**提示词：**
```
查看 nonexistent_table 表的结构
```

**预期结果：**
- 返回清晰的错误信息
- 说明表不存在

## 性能测试

### 测试大结果集

**提示词：**
```
查询 users 表的所有记录（如果有大量数据）
```

**预期结果：**
- 能够处理大量数据
- 返回结果（可能需要一些时间）

### 测试并发查询

快速连续发送多个查询请求，观察：
- 响应时间
- 是否有错误
- 缓存是否正常工作

## 故障排除

### 问题 1：Cursor 无法识别 MCP 服务器

**检查步骤：**
1. 确认 Cursor 配置文件中路径正确
2. 确认 conda 环境路径正确
3. 重启 Cursor
4. 检查 Cursor 的 MCP 日志

**提示词：**
```
检查 MCP 服务器连接状态
```

### 问题 2：数据库连接失败

**检查步骤：**
1. 确认 PostgreSQL 服务正在运行
2. 确认 `DATABASE_URL` 配置正确
3. 测试数据库连接：
   ```bash
   psql "postgresql://user:password@host:port/database"
   ```

**提示词：**
```
测试数据库连接
```

### 问题 3：查询返回错误

**检查步骤：**
1. 查看日志输出（设置 `LOG_LEVEL=DEBUG`）
2. 确认 SQL 语法正确
3. 确认表名和列名正确
4. 确认有查询权限

### 问题 4：缓存不工作

**检查步骤：**
1. 确认 `ENABLE_QUERY_CACHE=true`（默认启用）
2. 确认查询是 SELECT 查询（写操作会清空缓存）
3. 查看日志确认缓存状态

## 测试检查清单

使用以下检查清单确保所有功能正常：

- [ ] MCP 服务器连接成功
- [ ] 可以列出所有表
- [ ] 可以查看表结构
- [ ] 可以执行 SELECT 查询
- [ ] 查询结果格式正确
- [ ] 写操作被正确限制（如果未启用）
- [ ] 错误信息清晰有用
- [ ] 日志记录正常工作
- [ ] 缓存功能正常工作（如果启用）
- [ ] Prompts 功能可用

## 示例测试对话

以下是一个完整的测试对话示例：

**用户：**
```
帮我探索一下数据库，先列出所有表
```

**Cursor：**
（使用资源功能列出所有表）

**用户：**
```
查看 users 表的结构
```

**Cursor：**
（读取 table://public/users 资源，返回表结构）

**用户：**
```
查询 users 表的前 10 条记录
```

**Cursor：**
（使用 query 工具执行查询，返回数据）

**用户：**
```
统计一下 users 表中每个 status 的数量
```

**Cursor：**
（生成并执行聚合查询，返回统计结果）

## 提示词模板

以下是一些常用的测试提示词模板，你可以根据实际情况修改：

### 基础查询
- `查询 [表名] 表的前 [N] 条记录`
- `查看 [表名] 表的结构`
- `列出数据库中的所有表`

### 条件查询
- `查询 [表名] 表中 [条件] 的记录`
- `查找 [表名] 表中 [列名] 为 [值] 的数据`

### 聚合查询
- `统计 [表名] 表中的总记录数`
- `按 [列名] 分组统计 [表名] 表的数据`

### 连接查询
- `查询 [表1] 和 [表2] 表的连接数据`
- `找出 [表1] 和 [表2] 的关联数据`

### 分析查询
- `分析 [表名] 表的数据分布`
- `查看 [表名] 表的基本统计信息`

## 注意事项

1. **数据安全**：测试时注意不要修改生产数据
2. **性能影响**：大量查询可能影响数据库性能
3. **缓存一致性**：如果数据被外部修改，缓存可能不一致
4. **日志级别**：生产环境建议使用 INFO 或 WARNING 级别

## 相关文档

- [使用说明.md](./使用说明.md) - 安装和配置指南
- [开发计划.md](./开发计划.md) - 开发进度和计划
- [代码说明.md](./代码说明.md) - 代码结构说明
- [spec.md](./spec.md) - 功能规范

