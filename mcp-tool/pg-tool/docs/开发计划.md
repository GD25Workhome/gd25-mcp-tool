# PostgreSQL MCP 服务器开发计划

## 项目概述

根据 [Cursor MCP 服务器构建指南](https://docs.cursor.com/zh/guides/tutorials/building-mcp-server)，我们将构建一个 PostgreSQL MCP 服务器，让 Cursor 能够直接查询 PostgreSQL 数据库并访问表结构信息。

## 架构说明

```
┌─────────────┐
│ Cursor 用户 │
└──────┬──────┘
       │
       ▼
┌─────────────┐      stdio       ┌──────────────┐      SQL       ┌─────────────┐
│   Cursor    │ ◄──────────────► │  MCP 服务器  │ ◄───────────► │ PostgreSQL  │
│             │                  │  (pg-tool)   │               │   数据库    │
└─────────────┘                  └──────────────┘               └─────────────┘
```

**说明：**
- **stdio（标准输入/输出流）**：MCP 服务器通过标准输入/输出与 Cursor 通信，这是最简单的本地通信方式
- **MCP 服务器**：我们的 pg-tool，负责接收 Cursor 的请求，执行 SQL 查询，并返回结果
- **PostgreSQL 数据库**：实际的数据存储

## 开发步骤详解

### 步骤 1：项目初始化

**目标：** 搭建项目基础结构

**具体操作：**
1. 创建项目目录结构
2. 初始化包管理文件（package.json 或 requirements.txt）
3. 创建基本的项目文件

**为什么需要这一步：**
- 建立清晰的项目结构，便于后续开发
- 定义项目依赖，确保环境一致性

### 步骤 2：安装依赖

**目标：** 安装构建 MCP 服务器所需的库

**需要安装的依赖：**
- `@modelcontextprotocol/sdk`：MCP SDK，提供与 Cursor 通信的基础框架
- `postgres` 或 `psycopg2`：PostgreSQL 数据库连接库
- `zod` 或 `pydantic`：用于定义和验证输入/输出的模式（schema）

**为什么需要这些依赖：**
- **MCP SDK**：提供了 MCP 协议的标准实现，包括工具（tools）、资源（resources）、提示（prompts）等核心功能
- **PostgreSQL 库**：用于实际执行 SQL 查询
- **Schema 验证库**：确保输入参数符合预期格式，提高代码健壮性

### 步骤 3：创建规范文档（spec.md）

**目标：** 明确定义服务器的功能和约束

**规范内容：**
- 数据库连接配置方式（通过环境变量 DATABASE_URL）
- 工具功能：执行 SQL 查询（默认只读，可通过环境变量启用写操作）
- 资源功能：将数据表作为资源访问，提供表结构信息
- 使用 Schema 验证库定义输入输出格式

**为什么需要规范文档：**
- 作为开发的指导文档，确保实现符合预期
- 帮助理解项目需求，特别是在使用 AI 辅助开发时

### 步骤 4：实现 MCP 服务器核心功能

**目标：** 编写实际的服务器代码

**需要实现的功能：**

#### 4.1 工具（Tools）
- **query 工具**：执行 SQL 查询
  - 接收 SQL 查询字符串作为输入
  - 执行查询并返回结果
  - 默认只允许 SELECT 查询（只读）
  - 可通过环境变量 `DANGEROUSLY_ALLOW_WRITE_OPS=true` 启用写操作

**为什么需要工具：**
- 工具是 MCP 中暴露操作的方式，让 Cursor 能够执行具体的动作（如查询数据库）
- 通过工具，Cursor 可以动态调用我们的功能

#### 4.2 资源（Resources）
- **table_schemas 资源**：提供表结构信息
  - 列出所有表
  - 返回每个表的列信息、数据类型、约束等

**为什么需要资源：**
- 资源是 MCP 中共享标准化上下文的方式
- 表结构信息可以作为上下文提供给 Cursor，帮助生成更准确的查询

#### 4.3 服务器初始化
- 读取环境变量 `DATABASE_URL` 建立数据库连接
- 注册工具和资源
- 启动 stdio 服务器

**为什么需要这些：**
- 环境变量配置让服务器更灵活，可以在不同环境中使用不同的数据库
- stdio 服务器是与 Cursor 通信的桥梁

### 步骤 5：测试和配置

**目标：** 确保服务器正常工作

**测试方式：**
1. 使用 MCP Inspector 进行本地测试
2. 在 Cursor 中配置并测试

**配置文件：**
- 创建 Cursor 配置文件示例，说明如何连接 MCP 服务器

## MCP 核心概念说明

### 工具（Tools）
- **定义**：工具是 MCP 服务器暴露给 Cursor 的可执行操作
- **类比**：就像 API 的端点，Cursor 可以调用工具来执行特定任务
- **示例**：我们的 `query` 工具允许 Cursor 执行 SQL 查询

### 资源（Resources）
- **定义**：资源是 MCP 服务器提供的标准化数据或上下文
- **类比**：就像文件系统中的文件，Cursor 可以读取资源来获取信息
- **示例**：我们的 `table_schemas` 资源提供数据库表的结构信息

### 提示（Prompts）
- **定义**：提示是预定义的模板，可以帮助 Cursor 更好地理解如何与服务器交互
- **用途**：可以包含示例查询、最佳实践等
- **注意**：本项目中暂不实现，但这是 MCP 的高级功能

### stdio 传输
- **定义**：通过标准输入/输出流进行通信
- **优点**：简单、无需网络配置、适合本地开发
- **限制**：只能在本地运行，不适合团队共享

## 技术栈选择

根据项目需求和 Python 环境，我们选择：
- **语言**：Python 3.x
- **MCP SDK**：`mcp` (Python SDK)
- **数据库库**：`psycopg2` 或 `asyncpg`
- **Schema 验证**：`pydantic`

## 开发进度

### 已完成的任务

1. ✅ **项目初始化**
   - 创建项目目录结构
   - 创建 requirements.txt
   - 创建基本的项目文件（server.py, database.py, models.py）

2. ✅ **创建规范文档**
   - 完成 spec.md（项目功能规范）
   - 完成代码说明.md（代码详细说明）
   - 完成使用说明.md（用户使用指南）

3. ✅ **安装依赖**
   - 创建 conda 环境 `py311_gb25MCP_01`（Python 3.11.14）
   - 安装所有必需依赖：
     - mcp: 0.9.1
     - psycopg2-binary: 2.9.11
     - pydantic: 2.12.5
     - python-dotenv: 1.2.1
   - 验证版本兼容性：所有依赖版本符合要求
   - 验证依赖冲突：无冲突

4. ✅ **实现核心功能**
   - 实现 query 工具（执行 SQL 查询）
   - 实现资源功能（表结构信息）
   - 实现数据库连接管理
   - 实现 SQL 安全性检查（默认只读）

5. ✅ **测试和验证**
   - 语法检查通过
   - 模块导入测试通过
   - 程序可以正常加载

### 待完成的任务

1. ✅ **完善错误处理和日志记录**
   - ✅ 添加更详细的错误信息（区分业务错误和系统错误）
   - ✅ 实现日志记录功能（使用 Python logging 模块）
   - ✅ 改进异常处理机制（添加 exc_info 记录完整堆栈）
   - ✅ 支持通过环境变量 LOG_LEVEL 配置日志级别

2. ✅ **添加更多功能**
   - ✅ 实现提示（Prompts）功能（query-example, schema-query, join-query）
   - ⏳ 添加更多工具（如批量查询、表管理）
   - ✅ 优化资源访问性能（通过缓存）

3. ⏳ **文档完善**
   - ⏳ 更新 API 文档
   - ⏳ 添加更多使用示例
   - ⏳ 完善故障排除指南

4. ✅ **性能优化**
   - ✅ 实现查询结果缓存（SELECT 查询结果缓存，可配置 TTL）
   - ✅ 实现表结构缓存（减少重复查询 information_schema）
   - ✅ 缓存管理（自动清理过期缓存，限制缓存大小）
   - ⏳ 优化大结果集处理（分页支持）

## 下一步行动

根据当前进度，已完成：
1. ✅ 完善错误处理和日志记录（提高系统稳定性）
2. ✅ 添加提示（Prompts）功能（提升用户体验）
3. ✅ 性能优化（查询缓存和表结构缓存）

后续建议：
1. ⏳ 添加更多工具（批量查询、表管理等）
2. ⏳ 优化大结果集处理（分页、流式返回）
3. ⏳ 完善文档（API 文档、使用示例）

