# PostgreSQL MCP 服务器使用说明

## 环境信息

**Conda 环境：** `py311_gb25MCP_01`  
**Python 版本：** 3.11.14  
**环境路径：** `/opt/homebrew/Caskroom/miniconda/base/envs/py311_gb25MCP_01`

**已安装的依赖：**
- mcp: 0.9.1
- psycopg2-binary: 2.9.11
- pydantic: 2.12.5
- python-dotenv: 1.2.1

## 在 Cursor 中配置（推荐方法）

在 Cursor 的 MCP 配置文件中添加以下配置：

```json
{
  "mcpServers": {
    "postgres": {
      "command": "/opt/homebrew/Caskroom/miniconda/base/envs/py311_gb25MCP_01/bin/python",
      "args": [
        "/Users/m684620/work/github_GD25/gd25-mcp-tool/mcp-tool/pg-tool/server.py"
      ],
      "env": {
        "DATABASE_URL": "postgresql://postgres:sxl_pwd_123@localhost:5433/doctor_agent_db",
        "DANGEROUSLY_ALLOW_WRITE_OPS": "false"
      }
    }
  }
}
```

**配置说明：**
- `command`: 使用 conda 环境的完整 Python 路径（确保使用正确的环境）
- `args`: 服务器脚本的完整路径
- `env.DATABASE_URL`: 你的 PostgreSQL 数据库连接字符串
- `env.DANGEROUSLY_ALLOW_WRITE_OPS`: 设置为 `"false"` 只允许 SELECT 查询，设置为 `"true"` 允许写操作（需谨慎）

配置完成后，重启 Cursor 即可使用。

## 其它方案

### 方案 1：使用 .env 文件

如果希望使用 `.env` 文件管理环境变量，可以：

1. 创建 `.env` 文件：
```bash
cd /Users/m684620/work/github_GD25/gd25-mcp-tool/mcp-tool/pg-tool
cat > .env << EOF
DATABASE_URL=postgresql://postgres:sxl_pwd_123@localhost:5433/doctor_agent_db
DANGEROUSLY_ALLOW_WRITE_OPS=false
EOF
```

2. 在 Cursor 配置中省略 `env` 部分：
```json
{
  "mcpServers": {
    "postgres": {
      "command": "/opt/homebrew/Caskroom/miniconda/base/envs/py311_gb25MCP_01/bin/python",
      "args": [
        "/Users/m684620/work/github_GD25/gd25-mcp-tool/mcp-tool/pg-tool/server.py"
      ]
    }
  }
}
```

服务器会自动从 `.env` 文件加载环境变量。

### 方案 2：使用相对路径的 python 命令

如果系统 PATH 中已配置 conda 环境，可以使用：

```json
{
  "mcpServers": {
    "postgres": {
      "command": "python",
      "args": [
        "/Users/m684620/work/github_GD25/gd25-mcp-tool/mcp-tool/pg-tool/server.py"
      ],
      "env": {
        "DATABASE_URL": "postgresql://postgres:sxl_pwd_123@localhost:5433/doctor_agent_db",
        "DANGEROUSLY_ALLOW_WRITE_OPS": "false"
      }
    }
  }
}
```

**注意：** 此方法需要确保 Cursor 启动时能正确找到 conda 环境的 Python，可能不够可靠。

### 方案 3：手动测试连接

在终端中测试数据库连接：

```bash
# 激活 conda 环境
conda activate py311_gb25MCP_01

# 设置环境变量
export DATABASE_URL="postgresql://postgres:sxl_pwd_123@localhost:5433/doctor_agent_db"

# 进入项目目录
cd /Users/m684620/work/github_GD25/gd25-mcp-tool/mcp-tool/pg-tool

# 运行服务器测试连接
python server.py
```

如果看到 "数据库连接成功"，说明配置正确。

## 功能说明

### 工具（Tools）

#### query 工具
- **功能**：执行 SQL 查询
- **使用方式**：在 Cursor 中直接说"查询数据库"或"执行 SQL"
- **默认限制**：只允许 SELECT 查询（只读）
- **启用写操作**：设置 `DANGEROUSLY_ALLOW_WRITE_OPS=true`

**示例：**
```
用户：查询 users 表的前 10 条记录
Cursor：调用 query 工具，执行 SELECT * FROM users LIMIT 10
```

### 资源（Resources）

#### 表结构资源
- **URI 格式**：`table://<schema>/<table>`
- **功能**：提供表的结构信息（列名、数据类型、约束等）
- **特殊资源**：`table://*` 列出所有表

**示例：**
```
用户：查看 users 表的结构
Cursor：读取 table://public/users 资源，返回表结构信息
```

## 故障排除

### 1. 导入错误

**错误信息：** `ImportError: No module named 'mcp'`

**解决方案：**
```bash
# 激活正确的 conda 环境
conda activate py311_gb25MCP_01

# 进入项目目录
cd /Users/m684620/work/github_GD25/gd25-mcp-tool/mcp-tool/pg-tool

# 重新安装依赖
pip install -r requirements.txt

# 验证安装
pip check
```

如果问题仍然存在，检查 Cursor 配置中的 `command` 路径是否正确指向 conda 环境。

### 2. 数据库连接错误

**错误信息：** `无法连接到数据库`

**解决方案：**
- 检查 `DATABASE_URL` 是否正确
- 确认 PostgreSQL 服务正在运行
- 检查网络连接和防火墙设置
- 验证用户名和密码是否正确

### 3. 权限错误

**错误信息：** `写操作被禁用`

**解决方案：**
- 如果只需要查询，这是正常的安全限制
- 如果需要写操作，设置 `DANGEROUSLY_ALLOW_WRITE_OPS=true`
- **注意**：启用写操作有风险，请谨慎使用

## 开发说明

详细的开发计划和概念说明请参考：
- [开发计划.md](./开发计划.md) - 详细的开发步骤、MCP 概念说明和开发进度
- [spec.md](./spec.md) - 项目功能规范
- [测试说明.md](./测试说明.md) - 测试指南和提示词示例
- [MCP重载机制说明.md](./MCP重载机制说明.md) - 代码修改后的重载机制说明

## 常见问题

### 修改代码后需要重启 Cursor 吗？

**简短回答：**
- **修改配置文件或添加新工具/资源/提示**：需要重启 Cursor
- **只修改业务逻辑**：可以先试新建聊天框，不行再重启

**详细说明：** 请参考 [MCP重载机制说明.md](./MCP重载机制说明.md)

