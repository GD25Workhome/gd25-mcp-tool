# MCP 服务器重载机制说明

本文档说明在修改 MCP 服务器代码后，何时需要重启 Cursor，何时只需要新建聊天框。

## 核心机制

### MCP 服务器的启动方式

Cursor 使用 **stdio（标准输入/输出）** 方式与 MCP 服务器通信：

1. **启动时机**：Cursor 在启动时读取 MCP 配置文件，但**不会立即启动服务器**
2. **实际启动**：当你在聊天中**首次使用 MCP 功能**时，Cursor 才会启动服务器进程
3. **进程管理**：每个聊天会话可能会启动独立的服务器进程（取决于 Cursor 的实现）

## 何时需要重启 Cursor

### ✅ 必须重启 Cursor 的情况

#### 1. 修改 MCP 配置文件

**场景：**
- 修改 `cursor-config.json` 中的配置
- 修改 `command`、`args` 路径
- 添加或删除环境变量
- 添加新的 MCP 服务器

**原因：**
- Cursor 在启动时读取配置文件
- 配置更改需要重启才能生效

**操作：**
```bash
# 完全退出 Cursor，然后重新启动
```

#### 2. 添加新的工具（Tools）

**场景：**
- 在 `server.py` 的 `list_tools()` 中添加新的 `Tool`
- 在 `call_tool()` 中添加新的工具处理逻辑

**原因：**
- Cursor 在首次连接时会调用 `list_tools()` 获取工具列表
- 工具列表会被缓存，新工具需要重启才能被发现

**示例：**
```python
# 添加新工具后需要重启
@app.list_tools()
async def list_tools() -> list[Tool]:
    return [
        Tool(name="query", ...),  # 原有工具
        Tool(name="new_tool", ...),  # 新工具 - 需要重启
    ]
```

#### 3. 添加新的资源（Resources）

**场景：**
- 修改 `list_resources()` 返回的资源列表
- 添加新的资源 URI 模式

**原因：**
- 资源列表在首次连接时获取并缓存

#### 4. 添加新的提示（Prompts）

**场景：**
- 在 `list_prompts()` 中添加新的 `Prompt`

**原因：**
- 提示列表在首次连接时获取并缓存

#### 5. 修改工具/资源/提示的元数据

**场景：**
- 修改工具的描述（`description`）
- 修改工具的输入参数定义（`inputSchema`）
- 修改资源的 URI 格式

**原因：**
- 这些元数据在初始化时获取并缓存

#### 6. 修改导入的模块

**场景：**
- 修改 `database.py`、`models.py` 等被导入的模块
- 添加新的依赖包

**原因：**
- Python 模块在首次导入时会被缓存
- 修改后的代码需要重新导入才能生效

**注意：**
- 如果只是修改函数内部逻辑，可能不需要重启（见下文）

## 何时只需要新建聊天框

### ⚠️ 可能只需要新建聊天框的情况

#### 1. 修改工具的业务逻辑（不改变接口）

**场景：**
- 修改 `call_tool()` 中 `query` 工具的处理逻辑
- 修改 `database.py` 中 `execute_query()` 的实现
- 修改错误处理逻辑
- 修改日志输出

**原因：**
- 如果 Cursor 为每个聊天会话启动新的服务器进程
- 新进程会加载最新的代码
- **但这不是 100% 保证的**，取决于 Cursor 的实现

**操作：**
1. 保存代码修改
2. 关闭当前聊天框
3. 打开新的聊天框
4. 测试功能

**验证方法：**
- 如果新聊天框中功能正常，说明不需要重启
- 如果功能还是旧的，则需要重启 Cursor

#### 2. 修改资源读取逻辑

**场景：**
- 修改 `read_resource()` 中的处理逻辑
- 修改返回的数据格式（但不改变 URI）

**注意：**
- 如果修改了返回的数据结构，可能需要重启

#### 3. 修改日志级别

**场景：**
- 修改 `LOG_LEVEL` 环境变量（在配置文件中）
- 修改日志格式

**注意：**
- 如果是在配置文件中修改，需要重启
- 如果只是修改代码中的日志逻辑，可能只需要新聊天框

## 最佳实践

### 开发流程建议

#### 1. 开发阶段

```bash
# 1. 修改代码
vim server.py

# 2. 测试修改
# 方式 A：新建聊天框测试（推荐先试这个）
# 方式 B：如果不行，重启 Cursor

# 3. 如果修改了工具/资源/提示，直接重启 Cursor
```

#### 2. 快速验证方法

**测试脚本：**
```python
# test_reload.py
# 在代码中添加一个版本号，每次修改时更新
VERSION = "1.0.1"  # 修改这个版本号

@app.list_tools()
async def list_tools() -> list[Tool]:
    # 在工具描述中包含版本号
    return [
        Tool(
            name="query",
            description=f"执行 SQL 查询 (v{VERSION})",
            ...
        )
    ]
```

**验证步骤：**
1. 修改版本号
2. 新建聊天框
3. 询问："列出可用的工具"
4. 检查描述中是否包含新版本号
5. 如果没有，说明需要重启 Cursor

### 3. 修改类型判断表

| 修改类型 | 需要重启 Cursor | 只需要新聊天框 | 不确定 |
|---------|----------------|---------------|--------|
| 修改配置文件 | ✅ | | |
| 添加新工具 | ✅ | | |
| 修改工具描述 | ✅ | | |
| 修改工具参数定义 | ✅ | | |
| 修改工具业务逻辑 | | ⚠️ | ✅ |
| 添加新资源 | ✅ | | |
| 修改资源 URI | ✅ | | |
| 修改资源读取逻辑 | | ⚠️ | ✅ |
| 添加新提示 | ✅ | | |
| 修改提示定义 | ✅ | | |
| 修改数据库逻辑 | | ⚠️ | ✅ |
| 修改日志逻辑 | | ⚠️ | ✅ |
| 修改错误处理 | | ⚠️ | ✅ |
| 添加新依赖包 | ✅ | | |

### 4. 安全策略

**保守策略（推荐）：**
- 任何代码修改后，都重启 Cursor
- 确保 100% 生效，避免浪费时间调试

**快速策略：**
- 先尝试新建聊天框
- 如果不行，再重启 Cursor
- 适合频繁修改业务逻辑的场景

## 常见问题

### Q1: 我修改了 `server.py`，但新聊天框中还是旧代码？

**A:** 这说明需要重启 Cursor。可能的原因：
- Cursor 缓存了服务器进程
- Python 模块缓存（`__pycache__`）
- Cursor 复用了旧的服务器进程

**解决方案：**
1. 完全退出 Cursor
2. 清理 Python 缓存（可选）：
   ```bash
   find . -type d -name __pycache__ -exec rm -r {} +
   ```
3. 重新启动 Cursor

### Q2: 如何确认代码已更新？

**A:** 使用以下方法验证：

1. **添加日志输出：**
   ```python
   logger.info("服务器版本: 1.0.2")  # 每次修改时更新版本号
   ```

2. **在工具描述中包含版本：**
   ```python
   description=f"执行 SQL 查询 [v1.0.2]"
   ```

3. **添加测试功能：**
   ```python
   # 添加一个返回版本的工具
   Tool(
       name="version",
       description="返回服务器版本",
       ...
   )
   ```

### Q3: 修改了 `database.py`，需要重启吗？

**A:** 取决于修改内容：

- **修改函数内部逻辑**：可能只需要新聊天框
- **修改类结构**：需要重启
- **修改导入**：需要重启
- **添加新方法**：如果不在工具中使用，可能不需要重启

**建议：** 先试新聊天框，不行再重启。

### Q4: 如何快速重启 Cursor？

**A:** 

**macOS:**
```bash
# 完全退出
Cmd + Q

# 或者通过终端
killall Cursor
open -a Cursor
```

**Windows:**
```bash
# 任务管理器中结束进程，然后重新打开
```

**Linux:**
```bash
killall cursor
cursor &
```

### Q5: 有没有办法让 Cursor 自动重载？

**A:** 目前 Cursor 不支持自动重载。但你可以：

1. **使用开发模式：**
   - 在代码中添加版本检查
   - 每次修改时更新版本号
   - 通过工具返回版本号来验证

2. **使用文件监控（高级）：**
   - 使用 `watchdog` 等工具监控文件变化
   - 自动重启服务器（但这需要手动管理服务器进程）

## 调试技巧

### 1. 检查服务器是否已更新

**方法 1：查看日志**
```python
# 在 server.py 中添加
logger.info("=== 服务器启动 ===")
logger.info(f"代码版本: 1.0.3")
logger.info(f"启动时间: {time.time()}")
```

**方法 2：添加版本工具**
```python
@app.list_tools()
async def list_tools() -> list[Tool]:
    return [
        Tool(
            name="server_info",
            description="返回服务器信息",
            inputSchema={
                "type": "object",
                "properties": {},
                "required": []
            }
        ),
        # ... 其他工具
    ]

@app.call_tool()
async def call_tool(name: str, arguments: dict[str, Any]):
    if name == "server_info":
        return [TextContent(
            type="text",
            text=json.dumps({
                "version": "1.0.3",
                "start_time": "2024-01-01 12:00:00"
            })
        )]
    # ... 其他工具处理
```

### 2. 强制重新加载

如果怀疑代码没有更新：

1. **清理 Python 缓存：**
   ```bash
   cd /path/to/pg-tool
   find . -type d -name __pycache__ -exec rm -r {} +
   find . -name "*.pyc" -delete
   ```

2. **重启 Cursor**

3. **验证：**
   - 新建聊天框
   - 使用版本检查工具验证

## 总结

### 快速判断规则

1. **修改了配置文件？** → 重启 Cursor
2. **添加了新的工具/资源/提示？** → 重启 Cursor
3. **修改了工具/资源/提示的定义？** → 重启 Cursor
4. **只修改了函数内部逻辑？** → 先试新聊天框，不行再重启
5. **不确定？** → 直接重启 Cursor（最安全）

### 推荐工作流程

```
修改代码
    ↓
保存文件
    ↓
判断修改类型
    ↓
┌─────────────┬──────────────┐
│ 修改接口/配置 │ 修改业务逻辑 │
│   ↓         │     ↓        │
│ 重启 Cursor │ 新聊天框测试 │
│             │     ↓        │
│             │ 是否生效？   │
│             │ 是/否        │
│             │ ↓    ↓       │
│             │继续  重启    │
└─────────────┴──────────────┘
```

## 相关文档

- [使用说明.md](./使用说明.md) - 配置和安装指南
- [测试说明.md](./测试说明.md) - 测试方法和提示词
- [开发计划.md](./开发计划.md) - 开发进度

