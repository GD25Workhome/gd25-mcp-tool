# GitHub MCP 服务器开发计划

## 项目概述

根据 [Cursor MCP 服务器构建指南](https://docs.cursor.com/zh/guides/tutorials/building-mcp-server)，我们将构建一个 GitHub MCP 服务器，让 Cursor 能够直接与 GitHub 交互，搜索代码、获取仓库信息、管理 Issue 和 Pull Request。

## 架构说明

```
┌─────────────┐
│ Cursor 用户 │
└──────┬──────┘
       │
       ▼
┌─────────────┐      stdio       ┌──────────────┐      REST API    ┌─────────────┐
│   Cursor    │ ◄──────────────► │  MCP 服务器  │ ◄─────────────► │   GitHub    │
│             │                  │ (github-tool)│                 │     API     │
└─────────────┘                  └──────────────┘                 └─────────────┘
```

**说明：**
- **stdio（标准输入/输出流）**：MCP 服务器通过标准输入/输出与 Cursor 通信，这是最简单的本地通信方式
- **MCP 服务器**：我们的 github-tool，负责接收 Cursor 的请求，调用 GitHub API，并返回结果
- **GitHub API**：GitHub 提供的 REST API，用于访问仓库、代码、Issue、PR 等资源

## 开发步骤详解

### 步骤 1：项目初始化

**目标：** 搭建项目基础结构

**具体操作：**
1. 创建项目目录结构
2. 初始化依赖管理文件（requirements.txt）
3. 创建基本的项目文件

**为什么需要这一步：**
- 建立清晰的项目结构，便于后续开发
- 定义项目依赖，确保环境一致性

### 步骤 2：安装依赖

**目标：** 安装构建 MCP 服务器所需的库

**需要安装的依赖：**
- `mcp`：MCP Python SDK，提供与 Cursor 通信的基础框架
- `PyGithub`：GitHub API 的 Python 客户端库
- `pydantic`：用于定义和验证输入/输出的模式（schema）
- `python-dotenv`：环境变量管理

**为什么需要这些依赖：**
- **MCP SDK**：提供了 MCP 协议的标准实现，包括工具（tools）、资源（resources）、提示（prompts）等核心功能
- **PyGithub**：封装了 GitHub REST API，提供简洁的 Python 接口
- **Schema 验证库**：确保输入参数符合预期格式，提高代码健壮性

### 步骤 3：创建规范文档（spec.md）

**目标：** 明确定义服务器的功能和约束

**规范内容：**
- GitHub Token 配置方式（通过环境变量 GITHUB_TOKEN）
- 工具功能：代码搜索、仓库信息、文件内容、Issue 管理、PR 管理
- 资源功能：提供 GitHub 工具信息
- 使用 Schema 验证库定义输入输出格式

**为什么需要规范文档：**
- 作为开发的指导文档，确保实现符合预期
- 帮助理解项目需求，特别是在使用 AI 辅助开发时

### 步骤 4：实现 MCP 服务器核心功能

**目标：** 编写实际的服务器代码

**需要实现的功能：**

#### 4.1 工具（Tools）

**第一阶段（已完成）：**
- ✅ **search_code 工具**：在 GitHub 上搜索代码
  - 支持 GitHub 搜索语法
  - 搜索所有公共仓库或用户有权限的私有仓库
  
- ✅ **get_repo_info 工具**：获取仓库详细信息
  - 仓库描述、语言、Star 数、Fork 数等
  
- ✅ **get_file_content 工具**：获取文件内容
  - 支持指定分支、标签或提交 SHA
  
- ✅ **list_issues 工具**：列出仓库的 Issue
  - 支持按状态过滤（open, closed, all）
  
- ✅ **create_issue 工具**：创建新的 Issue
  - 支持设置标题、内容和标签
  
- ✅ **list_pull_requests 工具**：列出仓库的 Pull Request
  - 支持按状态过滤
  
- ✅ **list_user_repos 工具**：列出用户的所有仓库
  - 支持列出指定用户或当前认证用户的所有仓库
  - 返回统计信息（总数、公开数、私有数）

**第二阶段（已完成）：**
- ✅ **create_pull_request 工具**：创建 Pull Request
  - 从源分支创建到目标分支的 PR
  - 支持设置标题、描述、标签等
  
- ✅ **get_pull_request 工具**：获取 Pull Request 详细信息
  - PR 状态、变更文件、评论等
  
- ✅ **search_repositories 工具**：搜索仓库
  - 根据关键词、语言、Star 数等条件搜索
  
- ✅ **list_branches 工具**：列出仓库的分支
  - 获取所有分支列表
  
- ✅ **get_commit_info 工具**：获取提交信息
  - 提交详情、变更文件、作者等
  
- ✅ **list_commits 工具**：列出仓库的提交历史
  - 支持分页和过滤
  
- ✅ **update_issue 工具**：更新 Issue
  - 支持修改状态、标题、内容或标签

**为什么需要工具：**
- 工具是 MCP 中暴露操作的方式，让 Cursor 能够执行具体的动作（如搜索代码、创建 Issue）
- 通过工具，Cursor 可以动态调用我们的功能

#### 4.2 资源（Resources）

**第一阶段（已完成）：**
- ✅ **github://info 资源**：提供 GitHub 工具的功能说明

**第二阶段（已完成）：**
- ✅ **repo://owner/repo 资源**：仓库信息资源
  - 以资源形式提供仓库信息，便于 Cursor 获取上下文
  
- ✅ **file://owner/repo/path 资源**：文件内容资源
  - 以资源形式提供文件内容，支持版本控制（支持 ref 查询参数）
  
- ✅ **issue://owner/repo/number 资源**：Issue 信息资源
  - 以资源形式提供 Issue 信息

**为什么需要资源：**
- 资源是 MCP 中共享标准化上下文的方式
- 仓库信息、文件内容等可以作为上下文提供给 Cursor，帮助生成更准确的请求

#### 4.3 提示（Prompts）

**第一阶段（已完成）：**
- ✅ **search-code-example**：代码搜索示例
- ✅ **get-repo-example**：获取仓库信息示例
- ✅ **create-issue-example**：创建 Issue 示例

**第二阶段（已完成）：**
- ✅ **create-pr-example**：创建 Pull Request 示例
- ✅ **search-repo-example**：搜索仓库示例
- ✅ **manage-branch-example**：分支管理示例
- ✅ **commit-history-example**：提交历史示例

#### 4.4 服务器初始化
- 读取环境变量 `GITHUB_TOKEN` 初始化 GitHub 客户端
- 注册工具和资源
- 启动 stdio 服务器

**为什么需要这些：**
- 环境变量配置让服务器更灵活，可以在不同环境中使用不同的 Token
- stdio 服务器是与 Cursor 通信的桥梁

### 步骤 5：测试和配置

**目标：** 确保服务器正常工作

**测试方式：**
1. 使用 MCP Inspector 进行本地测试
2. 在 Cursor 中配置并测试

**配置文件：**
- 创建 Cursor 配置文件示例，说明如何连接 MCP 服务器

## MCP 核心概念说明

### 工具（Tools）
- **定义**：工具是 MCP 服务器暴露给 Cursor 的可执行操作
- **类比**：就像 API 的端点，Cursor 可以调用工具来执行特定任务
- **示例**：我们的 `search_code` 工具允许 Cursor 在 GitHub 上搜索代码

### 资源（Resources）
- **定义**：资源是 MCP 服务器提供的标准化数据或上下文
- **类比**：就像文件系统中的文件，Cursor 可以读取资源来获取信息
- **示例**：我们的 `github://info` 资源提供工具功能说明

### 提示（Prompts）
- **定义**：提示是预定义的模板，可以帮助 Cursor 更好地理解如何与服务器交互
- **用途**：可以包含示例查询、最佳实践等
- **示例**：我们的 `search-code-example` 提示帮助用户理解如何搜索代码

### stdio 传输
- **定义**：通过标准输入/输出流进行通信
- **优点**：简单、无需网络配置、适合本地开发
- **限制**：只能在本地运行，不适合团队共享

## 技术栈选择

根据项目需求和 Python 环境，我们选择：
- **语言**：Python 3.x
- **MCP SDK**：`mcp` (Python SDK)
- **GitHub API 库**：`PyGithub`
- **Schema 验证**：`pydantic`

## 开发进度

### 已完成的任务

1. ✅ **项目初始化**
   - 创建项目目录结构
   - 创建 requirements.txt
   - 创建基本的项目文件（server.py, github_client.py, models.py）

2. ✅ **创建规范文档**
   - 完成 spec.md（项目功能规范）
   - 完成代码说明.md（代码详细说明）
   - 完成使用说明.md（用户使用指南）

3. ✅ **安装依赖**
   - 使用 conda 环境 `py311_gb25MCP_01`（Python 3.11.14）
   - 安装所有必需依赖：
     - mcp: >=0.9.0,<1.0.0
     - PyGithub: >=2.1.0,<3.0.0
     - pydantic: >=2.0.0,<3.0.0
     - python-dotenv: >=1.0.0,<2.0.0

4. ✅ **实现核心功能（第一阶段）**
   - ✅ 实现 search_code 工具（代码搜索）
   - ✅ 实现 get_repo_info 工具（获取仓库信息）
   - ✅ 实现 get_file_content 工具（获取文件内容）
   - ✅ 实现 list_issues 工具（列出 Issue）
   - ✅ 实现 create_issue 工具（创建 Issue）
   - ✅ 实现 list_pull_requests 工具（列出 Pull Request）
   - ✅ 实现 list_user_repos 工具（列出用户仓库）
   - ✅ 实现资源功能（github://info）
   - ✅ 实现提示功能（3 个示例提示）
   - ✅ 实现 GitHub 客户端封装（github_client.py）
   - ✅ 实现数据模型（models.py）
   - ✅ 实现错误处理和日志记录

5. ✅ **实现第二阶段功能扩展**
   - ✅ 实现 create_pull_request 工具（创建 PR）
   - ✅ 实现 get_pull_request 工具（获取 PR 详情）
   - ✅ 实现 update_issue 工具（更新 Issue）
   - ✅ 实现 search_repositories 工具（搜索仓库）
   - ✅ 实现 list_branches 工具（列出分支）
   - ✅ 实现 get_commit_info 工具（获取提交信息）
   - ✅ 实现 list_commits 工具（列出提交历史）
   - ✅ 扩展资源功能（repo://, file://, issue://）
   - ✅ 扩展提示功能（4 个新示例提示）

5. ✅ **测试和验证**
   - ✅ 语法检查通过
   - ✅ 模块导入测试通过
   - ✅ 程序可以正常加载

### 待完成的任务

#### 第一阶段优化（高优先级）

1. ⏳ **完善错误处理和日志记录**
   - ⏳ 添加更详细的错误信息（区分 API 错误、权限错误、网络错误）
   - ⏳ 实现速率限制处理（检测并提示 API 速率限制）
   - ⏳ 改进异常处理机制（添加重试机制）
   - ✅ 支持通过环境变量 LOG_LEVEL 配置日志级别

2. ⏳ **性能优化**
   - ⏳ 实现 API 响应缓存（减少重复 API 调用）
   - ⏳ 实现仓库信息缓存（减少重复查询）
   - ⏳ 实现文件内容缓存（支持 TTL）
   - ⏳ 缓存管理（自动清理过期缓存，限制缓存大小）

3. ✅ **扩展资源功能**
   - ✅ 实现 repo://owner/repo 资源（仓库信息）
   - ✅ 实现 file://owner/repo/path 资源（文件内容，支持 ref 查询参数）
   - ✅ 实现 issue://owner/repo/number 资源（Issue 信息）

#### 第二阶段功能扩展（已完成）

4. ✅ **添加更多工具**
   - ✅ create_pull_request - 创建 Pull Request
   - ✅ get_pull_request - 获取 Pull Request 详细信息
   - ✅ update_issue - 更新 Issue（关闭、添加标签等）
   - ✅ search_repositories - 搜索仓库
   - ✅ list_branches - 列出仓库分支
   - ✅ get_commit_info - 获取提交信息
   - ✅ list_commits - 列出提交历史
   - ⏳ create_branch - 创建分支（待实现）
   - ⏳ get_file_tree - 获取目录树结构（待实现）

5. ✅ **扩展提示功能**
   - ✅ create-pr-example - 创建 PR 示例
   - ✅ search-repo-example - 搜索仓库示例
   - ✅ manage-branch-example - 分支管理示例
   - ✅ commit-history-example - 提交历史示例

#### 第三阶段高级功能（低优先级）

6. ⏳ **高级功能**
   - ⏳ 支持 GitHub Actions 工作流查询
   - ⏳ 支持 GitHub Releases 管理
   - ⏳ 支持 GitHub Gists 操作
   - ⏳ 支持 GitHub Discussions（如果仓库启用）
   - ⏳ 支持批量操作（批量创建 Issue、批量关闭 PR 等）

7. ⏳ **文档完善**
   - ⏳ 更新 API 文档（所有工具的详细说明）
   - ⏳ 添加更多使用示例
   - ⏳ 完善故障排除指南
   - ⏳ 添加最佳实践文档
   - ⏳ 添加性能优化指南

8. ⏳ **测试和验证**
   - ⏳ 编写单元测试
   - ⏳ 编写集成测试
   - ⏳ 添加 CI/CD 配置
   - ⏳ 性能测试和基准测试

## 下一步行动

根据当前进度，已完成第一阶段核心功能：
1. ✅ 实现 6 个基础工具（代码搜索、仓库信息、文件内容、Issue 管理、PR 列表）
2. ✅ 实现资源功能（github://info）
3. ✅ 实现提示功能（3 个示例）
4. ✅ 完善错误处理和日志记录

**近期优先级（建议顺序）：**

1. **性能优化**（高优先级）
   - 实现 API 响应缓存，减少重复调用
   - 实现仓库信息和文件内容缓存
   - 这将显著提升用户体验，减少 API 速率限制问题

2. **扩展资源功能**（高优先级）
   - 实现 repo://、file://、issue:// 资源
   - 让 Cursor 能够更方便地获取上下文信息

3. **添加常用工具**（中优先级）
   - create_pull_request - 创建 PR（非常常用）
   - get_pull_request - 获取 PR 详情
   - search_repositories - 搜索仓库
   - list_branches - 列出分支

4. **完善错误处理**（中优先级）
   - 实现速率限制检测和处理
   - 添加重试机制
   - 改进错误信息提示

5. **文档和测试**（持续进行）
   - 更新 API 文档
   - 添加使用示例
   - 编写测试用例

## 技术债务和注意事项

1. **API 速率限制**
   - GitHub API 有速率限制（未认证：60 次/小时，认证：5000 次/小时）
   - 需要实现缓存机制减少 API 调用
   - 需要检测并处理速率限制错误

2. **Token 权限管理**
   - 不同功能需要不同的 Token 权限
   - 需要文档说明每个工具所需的权限
   - 考虑实现权限检查和提示

3. **异步操作**
   - 当前实现是同步的（PyGithub 库限制）
   - 未来可以考虑使用异步 HTTP 客户端（如 aiohttp）直接调用 GitHub API

4. **大文件处理**
   - 当前 get_file_content 可能无法处理超大文件
   - 需要考虑文件大小限制和分块读取

5. **错误恢复**
   - 网络错误时的重试机制
   - Token 过期时的提示和恢复

