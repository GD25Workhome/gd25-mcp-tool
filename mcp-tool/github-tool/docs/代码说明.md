# 代码结构说明

本文档详细解释 github-tool 项目中每个文件的作用和代码逻辑。

## 项目文件结构

```
github-tool/
├── server.py                    # MCP 服务器主文件（入口点）
├── github_client.py             # GitHub API 客户端封装
├── models.py                    # Pydantic 数据模型定义
├── requirements.txt             # Python 依赖列表
├── cursor-config.json.example   # Cursor 配置示例
├── README.md                    # 项目概述
└── docs/                        # 文档目录
    ├── spec.md                  # 项目功能规范
    ├── 使用说明.md              # 安装和使用指南
    └── 代码说明.md              # 本文件：代码结构说明
```

## 核心文件详解

### 1. server.py - MCP 服务器主文件

**作用**：这是 MCP 服务器的入口点，负责与 Cursor 通信。

**关键组件**：

#### 1.1 服务器初始化
```python
app = Server("github-mcp-server")
```
- 创建 MCP 服务器实例
- `"github-mcp-server"` 是服务器名称，会在 Cursor 中显示

#### 1.2 GitHub 客户端初始化
```python
github_client = GitHubClient(github_token)
```
- 使用 GitHub Token 初始化客户端
- Token 从环境变量 `GITHUB_TOKEN` 读取

#### 1.3 工具注册（@app.list_tools）
- **作用**：告诉 Cursor 这个服务器提供哪些工具
- **返回**：工具列表，每个工具包含名称、描述和输入参数定义
- **我们的工具**：
  - `search_code` - 搜索代码
  - `get_repo_info` - 获取仓库信息
  - `get_file_content` - 获取文件内容
  - `list_issues` - 列出 Issue
  - `create_issue` - 创建 Issue
  - `list_pull_requests` - 列出 Pull Request

#### 1.4 工具调用处理（@app.call_tool）
- **作用**：当 Cursor 调用工具时，执行实际的逻辑
- **流程**：
  1. 接收工具名称和参数
  2. 验证参数（使用 Pydantic 模型）
  3. 调用 GitHub 客户端执行操作
  4. 返回结果给 Cursor

#### 1.5 资源注册（@app.list_resources）
- **作用**：提供资源列表（当前主要提供工具，资源较少）
- **资源**：`github://info` - GitHub 工具信息

#### 1.6 提示注册（@app.list_prompts）
- **作用**：提供预定义的提示模板，帮助 Cursor 更好地使用工具
- **提示**：代码搜索示例、获取仓库示例、创建 Issue 示例

### 2. github_client.py - GitHub API 客户端封装

**作用**：封装 GitHub API 调用，提供简洁的接口。

**关键类**：

#### 2.1 GitHubClient 类
- **初始化**：使用 GitHub Token 创建 PyGithub 客户端
- **方法**：
  - `search_code(query)` - 搜索代码
  - `get_repository(owner, repo)` - 获取仓库对象
  - `get_repo_info(owner, repo)` - 获取仓库信息
  - `get_file_content(owner, repo, path, ref)` - 获取文件内容
  - `list_issues(owner, repo, state, limit)` - 列出 Issue
  - `create_issue(owner, repo, title, body, labels)` - 创建 Issue
  - `list_pull_requests(owner, repo, state, limit)` - 列出 Pull Request

**错误处理**：
- 捕获 `GithubException` 并提供清晰的错误信息
- 处理 404 错误（仓库/文件不存在）
- 处理权限错误和速率限制

**数据转换**：
- 将 PyGithub 对象转换为字典
- 处理日期时间格式（转换为 ISO 格式字符串）
- 解码 Base64 编码的文件内容

### 3. models.py - Pydantic 数据模型

**作用**：定义所有输入输出的数据模型，确保类型安全和数据验证。

**输入模型**：
- `SearchCodeInput` - 代码搜索输入
- `GetRepoInfoInput` - 获取仓库信息输入
- `GetFileContentInput` - 获取文件内容输入
- `ListIssuesInput` - 列出 Issue 输入
- `CreateIssueInput` - 创建 Issue 输入
- `ListPullRequestsInput` - 列出 Pull Request 输入

**输出模型**：
- `SearchCodeResult` - 代码搜索结果
- `RepoInfo` - 仓库信息
- `FileContent` - 文件内容
- `IssueInfo` - Issue 信息
- `PullRequestInfo` - Pull Request 信息

**验证规则**：
- 必需字段验证
- 枚举值验证（如 state 必须是 open/closed/all）
- 数值范围验证（如 limit 必须在 1-100 之间）

## 数据流

### 工具调用流程

1. **Cursor 发起请求**
   ```
   Cursor → MCP Protocol → server.py (call_tool)
   ```

2. **参数验证**
   ```
   server.py → Pydantic 模型验证 → 验证通过/失败
   ```

3. **调用 GitHub API**
   ```
   server.py → github_client.py → PyGithub → GitHub API
   ```

4. **返回结果**
   ```
   GitHub API → PyGithub → github_client.py → server.py → Cursor
   ```

### 错误处理流程

1. **GitHub API 错误**
   - `GithubException` → 转换为 `ValueError` → 返回错误信息给 Cursor

2. **参数验证错误**
   - Pydantic 验证失败 → 返回验证错误信息

3. **其他错误**
   - 捕获所有异常 → 记录日志 → 返回通用错误信息

## 依赖关系

```
server.py
  ├── github_client.py (GitHub API 封装)
  ├── models.py (数据模型)
  └── mcp SDK (MCP 协议)

github_client.py
  └── PyGithub (GitHub API 库)

models.py
  └── pydantic (数据验证)
```

## 扩展指南

### 添加新工具

1. **在 models.py 中添加输入模型**：
   ```python
   class NewToolInput(BaseModel):
       param1: str = Field(..., description="参数1")
   ```

2. **在 github_client.py 中添加方法**：
   ```python
   def new_tool_method(self, param1: str) -> Dict[str, Any]:
       # 实现逻辑
       pass
   ```

3. **在 server.py 中注册工具**：
   - 在 `list_tools()` 中添加 Tool 定义
   - 在 `call_tool()` 中添加处理逻辑

### 添加新资源

1. **在 server.py 的 `list_resources()` 中添加资源定义**
2. **在 `read_resource()` 中添加读取逻辑**

## 日志记录

- 使用 Python `logging` 模块
- 日志级别可通过环境变量 `LOG_LEVEL` 设置
- 日志输出到 `stderr`，避免干扰 MCP 通信
- 记录关键操作和错误信息

## 性能考虑

1. **API 速率限制**：
   - GitHub API 有速率限制（认证：5000 次/小时）
   - 代码搜索结果限制为前 30 个
   - Issue/PR 列表限制为最多 100 条

2. **异步操作**：
   - MCP 服务器使用异步 I/O
   - GitHub API 调用是同步的（PyGithub 库限制）

3. **缓存**（未来优化）：
   - 可以考虑添加缓存机制减少 API 调用
   - 缓存仓库信息、文件内容等

